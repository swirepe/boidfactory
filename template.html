<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Links & Viewer (Dark, Controls, URL Params)</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
:root{
    /* Theme */
    --bg:#0b0e12;
    --panel:#0f141b;
    --text:#e6edf3;
    --muted:#9fb0c0;
    --border:#1c2530;

    /* Accent derived from hue (updated by JS) */
    --hue: 220;
    --accent: hsl(var(--hue), 70%, 60%);

    /* Layout */
    --sidebar: 280px;
    --sidebar-min: 0px;
    --handle: 42px;
    --radius:10px;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--text);
    font:14px/1.45 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
  }

  .app{display:grid;grid-template-columns:var(--sidebar) 1fr;grid-template-rows:100vh;transition:grid-template-columns .25s ease}#collapse{position:absolute;inline-size:1px;block-size:1px;clip:rect(0 0 0 0);clip-path:inset(50%);overflow:hidden;white-space:nowrap;border:0;padding:0;margin:-1px}.handle{position:fixed;top:12px;left:12px;width:var(--handle);height:36px;display:inline-flex;align-items:center;justify-content:center;background:#0a0e13;border:1px solid var(--border);color:var(--text);border-radius:var(--radius);cursor:pointer;user-select:none;gap:6px;font-size:12px;transition:background .2s ease,border-color .2s ease,transform .25s ease;z-index:15}.handle:hover{background:#0c1117;border-color:color-mix(in oklab,var(--accent),#17324a 60%)}.handle .chev{display:inline-block;transition:transform .25s ease}#collapse:checked+label.handle .chev{transform:rotate(180deg)}#collapse:checked ~ .app{grid-template-columns:var(--sidebar-min) 1fr}#collapse:checked ~ .app nav{transform:translateX(calc(-1*var(--sidebar)));opacity:0;pointer-events:none}nav{background:linear-gradient(180deg,var(--panel),#0c1117);border-right:1px solid var(--border);padding:12px;min-width:0;overflow:auto;transition:transform .25s ease,opacity .25s ease;padding-top:60px}nav h1{margin:0 0 10px;font-size:15px;color:var(--muted)}.controls{display:grid;gap:10px;margin:10px 0 14px 0;padding:10px;border:1px solid var(--border);border-radius:10px;background:#0a0e13}.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}label{color:var(--muted);font-size:12px}input[type=range]{width:160px}input[type=text],input[type=url]{width:100%;max-width:100%;padding:8px 10px;border-radius:8px;border:1px solid var(--border);background:#0a0e13;color:var(--text)}.switch{display:inline-flex;align-items:center;gap:8px;cursor:pointer;padding:6px 8px;border-radius:8px;border:1px solid var(--border);background:#0a0e13}.pill{display:inline-block;min-width:34px;text-align:center;padding:2px 8px;border-radius:999px;border:1px solid var(--border);color:var(--text);background:#0c1117}nav ul{list-style:none;padding:0;margin:0}
  
  /* <!-- CHANGED: List items are now flex containers for the download button --> */
  nav li{margin:6px 0; display:grid; grid-template-columns: 2fr 40px; gap:6px; align-items:center;}
  nav a{display:block;text-decoration:none;color:var(--text);padding:9px 10px;background:#0a0e13;border:1px solid transparent;border-radius:8px; flex-grow:2; min-width:0; /* Grow to fill space */}
  nav a:hover{background:#0c1117;border-color:var(--border)}
  nav a strong{color:var(--accent); transition: color .2s ease;}
  /* <!-- ADDED: Styles for active link highlighting --> */
  nav a.active {
    background: color-mix(in oklab, var(--accent), var(--panel) 85%);
    border-color: var(--accent);
  }
  nav a.active strong {
    color: var(--text);
  }

  /* <!-- ADDED: Styles for the download button --> */
  .download-btn {
    flex-shrink: 0;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 8px;
    background: transparent;
    border: 1px solid transparent;
    border-radius: 8px;
    color: var(--muted);
    cursor: pointer;
    transition: all .2s ease;
  }
  .download-btn:hover {
    background: #0c1117;
    border-color: var(--border);
    color: var(--accent);
  }
  
  .radio-group{width:100%; gap:8px; background:#0c1117; padding:4px; border-radius:8px; border:1px solid var(--border);}
  .radio-group label{display:flex; align-items:center; gap:5px; padding:3px 8px; border-radius:6px; cursor:pointer; transition: background .2s ease, color .2s ease;}
  .radio-group input{accent-color: var(--accent); width:14px; height:14px;}
  .radio-group input:checked + span{color:var(--text);}
  .radio-group label:has(input:checked){background: var(--border);}

  /* Viewer */
  main{min-width:0; display:flex; flex-direction:column}
  header.page{padding:10px; border-bottom:1px solid var(--border); background:#0c1117;}
  header.page h2{margin:0; font-size:16px}
  header.page p{margin:2px 0 0 0; color:var(--muted); font-size:12px}
  iframe{flex:1; width:100%; border:none; background:#0a0e13}
  #current-path{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:11px;margin-top:5px}#current-path a{color:var(--muted);text-decoration:none;border-bottom:1px dotted transparent;transition:all .2s ease}#current-path a:hover{color:var(--accent);border-bottom-color:var(--accent)}#current-path code{background:var(--border);padding:2px 5px;border-radius:4px}
  
  /* <!-- CHANGED: Better mobile responsive behavior for the sidebar --> */
  @media (max-width: 720px){
    .app{ grid-template-columns: 1fr; } /* Let main content take full width */
    nav{
      /* Make nav a slide-in overlay */
      position: fixed; z-index: 10;
      top: 0; left: 0; height: 100%;
      width: var(--sidebar); max-width: 85vw;
      box-shadow: 2px 0 8px rgba(0,0,0,0.3);
      /* This is the default (hidden) state on mobile */
      transform:translateX(calc(-1*var(--sidebar)));
      opacity:0;
      pointer-events:none;
    }
    /* When toggle is checked, show the nav overlay */
    #collapse:checked ~ .app nav{
      transform: translateX(0);
      opacity: 1;
      pointer-events: auto;
    }
    /* On mobile, the default handle icon should indicate "open" (rotated) */
    .handle .chev {
      transform: rotate(180deg);
    }
    /* When checked (open), it should indicate "close" (normal) */
    #collapse:checked+label.handle .chev{
      transform: rotate(0deg);
    }
  }
</style>
</head>
<body>
<input type="checkbox" id="collapse" aria-label="Collapse sidebar" />
<label class="handle" for="collapse" aria-controls="sidebar" aria-expanded="true" title="Toggle sidebar"><span class="chev">⟨⟩</span></label>
<div class="app">
  <nav id="sidebar">
    <h1>Links</h1>
    <div class="controls" id="controls">
      <div class="row"><label for="hueRange">hue</label><input id="hueRange" type="range" min="0" max="360" step="1" /><input id="hueColor" type="color" /><span class="pill" id="hueVal">220</span></div>
      <div class="row"><label class="switch"><input id="debugToggle" type="checkbox" /><span>debug</span></label><span class="pill" id="debugVal">true</span></div>
      <div class="row"><label for="headerText">header</label><input id="headerText" type="text" placeholder="Header text..." /></div>
      <div class="row"><label for="subheaderText">subheader</label><input id="subheaderText" type="text" placeholder="Subheader text..." /></div>
      <div class="row">
        <div class="radio-group" id="displayModeGroup">
          <label>Display</label>
          <label><input type="radio" name="displayMode" value="title" checked><span>Title</span></label>
          <label><input type="radio" name="displayMode" value="filename"><span>Filename</span></label>
          <label><input type="radio" name="displayMode" value="both"><span>Both</span></label>
        </div>
      </div>
    </div>
    <ul id="linkList">
<!-- LINK_LIST_PLACEHOLDER -->
    </ul>
  </nav>
  <main>
    <header class="page">
      <h2 id="hdr">Links & Viewer</h2>
      <p id="subhdr">Dark theme • URL-parameterized links</p>
      <p id="current-path">Select a file to view its shareable link here</p>
    </header>
    <iframe name="viewer" src="about:blank" title="Viewer"></iframe>
  </main>
</div>
<script>
const CONTROL_KEYS = new Set(['hue','debug','header','subheader']);
let currentSelectedPath = null;

function getInitialState(){
  const sp = new URLSearchParams(location.search);
  const state = {
    hue: Number.isFinite(+sp.get('hue')) ? Math.max(0, Math.min(360, +sp.get('hue'))) : 220,
    debug: (sp.has('debug') ? /^(1|true|yes|on)$/i.test(sp.get('debug')) : true),
    header: sp.get('header') ?? '',
    subheader: sp.get('subheader') ?? ''
  };
  return state;
}

function buildParams(state, includeOtherParams=true){
  const base = includeOtherParams ? new URLSearchParams(location.search) : new URLSearchParams();
  base.set('hue', String(state.hue));
  base.set('debug', state.debug ? 'true' : 'false');
  if (state.header && state.header.trim()) base.set('header', state.header.trim()); else base.delete('header');
  if (state.subheader && state.subheader.trim()) base.set('subheader', state.subheader.trim()); else base.delete('subheader');
  return base;
}

function updateTheme(hue){
  document.documentElement.style.setProperty('--hue', String(hue));
  document.getElementById('hdr').style.color = `hsl(${hue},70%,75%)`;
}

function applyToLinks(state){
  const params = buildParams(state, false);
  for (const a of document.querySelectorAll('#linkList a:not(.download-btn)')) { // Exclude download buttons
    try {
      const url = new URL(a.getAttribute('href'), location.href);
      const merged = new URLSearchParams(url.search);
      for (const [k,v] of params.entries()){ merged.set(k, v); }
      url.search = merged.toString();
      a.setAttribute('href', url.toString());
    } catch {
      const sep = a.href.includes('?') ? '&' : '?'; a.href = a.href + sep + params.toString();
    }
  }
}

function syncHeaderTexts(state){
  const hdr = document.getElementById('hdr');
  const subhdr = document.getElementById('subhdr');
  hdr.textContent = state.header?.trim() ? state.header.trim() : 'Links & Viewer';
  subhdr.textContent = state.subheader?.trim() ? state.subheader.trim() : 'Dark theme • URL-parameterized links';
}

function renderHeaderLink(){
  const currentPathEl = document.getElementById('current-path');
  if (!currentSelectedPath) { currentPathEl.innerHTML = 'Select a file to view its shareable link here'; return; }
  const params = buildParams(state, false);
  const finalUrl = `${currentSelectedPath}?${params.toString()}`;
  currentPathEl.innerHTML = `<a href="${finalUrl}" target="_blank" rel="noopener noreferrer" title="Open in new tab"><code>${currentSelectedPath}</code></a>`;
}

function updateLinkDisplay(mode) {
  const links = document.querySelectorAll('#linkList li');
  for (const li of links) {
    const title = li.dataset.title;
    const filename = li.dataset.filename;
    const strongEl = li.querySelector('a:not(.download-btn) strong');

    if (strongEl) {
      let newText = title; // Default to title
      if (mode === 'filename') {
        newText = filename;
      } else if (mode === 'both') {
        newText = `${title} <small style="color:var(--muted); margin-left: 4px;">(${filename})</small>`;
        strongEl.innerHTML = newText; // Use innerHTML for the <small> tag
        continue; // Skip the textContent update below
      }
      strongEl.textContent = newText;
    }
  }
}

/* ========= Wiring ========= */
const state = getInitialState();
const hueRange = document.getElementById('hueRange');
const hueColor = document.getElementById('hueColor');
const hueVal = document.getElementById('hueVal');
const debugToggle = document.getElementById('debugToggle');
const debugVal = document.getElementById('debugVal');
const headerText = document.getElementById('headerText');
const subheaderText = document.getElementById('subheaderText');
const linkList = document.getElementById('linkList');
const displayModeGroup = document.getElementById('displayModeGroup');

hueRange.value = state.hue; hueVal.textContent = state.hue;
debugToggle.checked = !!state.debug; debugVal.textContent = state.debug ? 'true' : 'false';
headerText.value = state.header; subheaderText.value = state.subheader;
(function(){const h=state.hue; hueColor.value=hslToHex(h,100,50);})();

updateTheme(state.hue); syncHeaderTexts(state); applyToLinks(state); renderHeaderLink();
replaceUrl(buildParams(state, true));

/* Control events */
hueRange.addEventListener('input',()=>{state.hue=clamp(+hueRange.value,0,360);hueVal.textContent=state.hue;hueColor.value=hslToHex(state.hue,100,50);updateAll();});
hueColor.addEventListener('input',()=>{const{h}=hexToHsl(hueColor.value);state.hue=Math.round(h);hueRange.value=state.hue;hueVal.textContent=state.hue;updateAll();});
debugToggle.addEventListener('change',()=>{state.debug=!!debugToggle.checked;debugVal.textContent=state.debug?'true':'false';updateAll();});
headerText.addEventListener('input',()=>{state.header=headerText.value;updateAll(true);});
subheaderText.addEventListener('input',()=>{state.subheader=subheaderText.value;updateAll(true);});

// <!-- CHANGED: Link click listener updated for active state and mobile UX -->
linkList.addEventListener('click', (e) => {
  const link = e.target.closest('a:not(.download-btn)');
  if (!link) return;

  // Remove active class from previously selected link
  const currentActive = linkList.querySelector('a.active');
  if (currentActive) {
    currentActive.classList.remove('active');
  }
  // Add active class to the clicked link
  link.classList.add('active');

  // Update header path
  const path = link.getAttribute('href').split('?')[0];
  currentSelectedPath = decodeURIComponent(path);
  renderHeaderLink();
  
  // On mobile, auto-close the sidebar after selection
  if (window.innerWidth <= 720) {
    document.getElementById('collapse').checked = false;
  }
});

displayModeGroup.addEventListener('change', (event) => {
  if (event.target.name === 'displayMode') {
    updateLinkDisplay(event.target.value);
  }
});

/* Helpers */
function updateAll(quiet=false){updateTheme(state.hue);syncHeaderTexts(state);applyToLinks(state);renderHeaderLink();const p=buildParams(state,true);replaceUrl(p);}
function replaceUrl(p){const u=new URL(location.href);u.search=p.toString();history.replaceState(null,'',u.toString());}
function clamp(n,a,b){return Math.max(a,Math.min(b,n));}
function hslToHex(h,s,l){s/=100;l/=100;const k=n=>(n+h/30)%12,a=s*Math.min(l,1-l),f=n=>l-a*Math.max(-1,Math.min(k(n)-3,Math.min(9-k(n),1))),toHex=x=>(Math.round(255*x)).toString(16).padStart(2,'0');return`#${toHex(f(0))}${toHex(f(8))}${toHex(f(4))}`}
function hexToHsl(h){let r=0,g=0,b=0;const m=h.replace('#','');if(m.length===3){r=parseInt(m[0]+m[0],16);g=parseInt(m[1]+m[1],16);b=parseInt(m[2]+m[2],16)}else{r=parseInt(m.slice(0,2),16);g=parseInt(m.slice(2,4),16);b=parseInt(m.slice(4,6),16)}r/=255;g/=255;b/=255;const max=Math.max(r,g,b),min=Math.min(r,g,b);let e,s,l=(max+min)/2;if(max===min)e=s=0;else{const d=max-min;s=l>0.5?d/(2-max-min):d/(max+min);switch(max){case r:e=(g-b)/d+(g<b?6:0);break;case g:e=(b-r)/d+2;break;case b:e=(r-g)/d+4;break}e*=60}return{h:e,s:s*100,l:l*100}}
</script>
</body>
</html>